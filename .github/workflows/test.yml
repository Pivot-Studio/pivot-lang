name: test
on:
  pull_request:
    types:
      - opened
  push:
    branches:
      - "master"
      - "release/*"

jobs:
  container-test-job:
    runs-on: ubuntu-latest
    container: registry.cn-hangzhou.aliyuncs.com/pivotstudio/rust-pl:latest
    steps:
      - uses: actions/checkout@v2
      - name: auto test
        run: |
          export KAGARI_LIB_ROOT=$(pwd)/planglib
          cargo test --all
          bash -c 'for file in target/debug/deps/plc-*; do [ -x "$file" ] || continue; mkdir -p "target/cov/$(basename $file)"; /kcov-build/usr/local/bin/kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file"; done'
          bash -c 'for file in target/debug/deps/vm-*; do [ -x "$file" ] || continue; mkdir -p "target/cov/$(basename $file)"; /kcov-build/usr/local/bin/kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file"; done'
          ls target/cov/
          wget https://codecov.io/bash
          chmod +x bash
          ./bash
          echo "Uploaded code coverage"