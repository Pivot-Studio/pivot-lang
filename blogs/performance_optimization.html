<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>performance optimization - Pivot Lang</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../././mdbook-admonish.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../About.html"><strong aria-hidden="true">1.</strong> About</a></li><li class="chapter-item expanded "><a href="../tutorial/index.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tutorial/installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../tutorial/basicproject.html"><strong aria-hidden="true">2.2.</strong> Basic Project</a></li><li class="chapter-item expanded "><a href="../tutorial/vscsupport.html"><strong aria-hidden="true">2.3.</strong> VSC Support</a></li></ol></li><li class="chapter-item expanded "><a href="../references/index.html"><strong aria-hidden="true">3.</strong> References</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../references/basic.html"><strong aria-hidden="true">3.1.</strong> Basic</a></li><li class="chapter-item expanded "><a href="../references/operator/index.html"><strong aria-hidden="true">3.2.</strong> Operator</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../references/operator/tyops.html"><strong aria-hidden="true">3.2.1.</strong> Type Operator</a></li></ol></li><li class="chapter-item expanded "><a href="../references/array.html"><strong aria-hidden="true">3.3.</strong> Array</a></li><li class="chapter-item expanded "><a href="../references/closure.html"><strong aria-hidden="true">3.4.</strong> closure</a></li><li class="chapter-item expanded "><a href="../references/module.html"><strong aria-hidden="true">3.5.</strong> Module</a></li><li class="chapter-item expanded "><a href="../references/method.html"><strong aria-hidden="true">3.6.</strong> Method</a></li><li class="chapter-item expanded "><a href="../references/interface.html"><strong aria-hidden="true">3.7.</strong> Trait</a></li><li class="chapter-item expanded "><a href="../references/generic.html"><strong aria-hidden="true">3.8.</strong> Generic</a></li><li class="chapter-item expanded "><a href="../references/tuple.html"><strong aria-hidden="true">3.9.</strong> Tuple</a></li><li class="chapter-item expanded "><a href="../references/deconstruct.html"><strong aria-hidden="true">3.10.</strong> Deconstruct</a></li><li class="chapter-item expanded "><a href="../references/union.html"><strong aria-hidden="true">3.11.</strong> Union</a></li><li class="chapter-item expanded "><a href="../references/macro.html"><strong aria-hidden="true">3.12.</strong> Macro</a></li></ol></li><li class="chapter-item expanded "><a href="../dev-prepare.html"><strong aria-hidden="true">4.</strong> Dev Prepare</a></li><li class="chapter-item expanded "><a href="../compiler/index.html"><strong aria-hidden="true">5.</strong> Compiler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../compiler/parser.html"><strong aria-hidden="true">5.1.</strong> Parser</a></li><li class="chapter-item expanded "><a href="../compiler/ast.html"><strong aria-hidden="true">5.2.</strong> AST</a></li><li class="chapter-item expanded "><a href="../compiler/flow.html"><strong aria-hidden="true">5.3.</strong> Flow Chart</a></li></ol></li><li class="chapter-item expanded "><a href="../lsp/index.html"><strong aria-hidden="true">6.</strong> Language Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lsp/design.html"><strong aria-hidden="true">6.1.</strong> Design</a></li><li class="chapter-item expanded "><a href="../lsp/diagnostic.html"><strong aria-hidden="true">6.2.</strong> Diagnostic</a></li></ol></li><li class="chapter-item expanded "><a href="../systemlib/index.html"><strong aria-hidden="true">7.</strong> System library</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../systemlib/vm.html"><strong aria-hidden="true">7.1.</strong> vm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../systemlib/gc.html"><strong aria-hidden="true">7.1.1.</strong> gc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../systemlib/immix.html"><strong aria-hidden="true">7.1.1.1.</strong> Immix Gc</a></li><li class="chapter-item expanded "><a href="../systemlib/stackmap.html"><strong aria-hidden="true">7.1.1.2.</strong> Stack Map</a></li><li class="chapter-item expanded "><a href="../systemlib/eva.html"><strong aria-hidden="true">7.1.1.3.</strong> Evacuation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../systemlib/planglib.html"><strong aria-hidden="true">7.2.</strong> planglib</a></li></ol></li><li class="chapter-item expanded "><a href="../compiler_theory/index.html"><strong aria-hidden="true">8.</strong> compiler theory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../compiler_theory/top-down_parsing.html"><strong aria-hidden="true">8.1.</strong> top-down parsing</a></li></ol></li><li class="chapter-item expanded "><a href="../CONTRIBUTING-CN.html"><strong aria-hidden="true">9.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../blogs/index.html"><strong aria-hidden="true">10.</strong> Blogs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../blogs/aboutpl.html"><strong aria-hidden="true">10.1.</strong> About pivot lang</a></li><li class="chapter-item expanded "><a href="../blogs/lsp_and_salsa.html"><strong aria-hidden="true">10.2.</strong> lsp and salsa</a></li><li class="chapter-item expanded "><a href="../blogs/gc_for_beginner.html"><strong aria-hidden="true">10.3.</strong> GC basic tutorial</a></li><li class="chapter-item expanded "><a href="../blogs/performance_optimization.html" class="active"><strong aria-hidden="true">10.4.</strong> performance optimization</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Pivot Lang</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Pivot-Studio/pivot-lang" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Pivot-Studio/pivot-lang/edit/master/book/src/blogs/performance_optimization.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="performance-optimization"><a class="header" href="#performance-optimization">Performance Optimization</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>Performance matters. Although speed may not be the most important factor in some languages, it is a universal truth that nearly all languages can benefit from higher performance.</p>
<p>Higher performance can lead to better user experience, lower server costs, and more efficient use of resources. It can also give your application a competitive edge.</p>
<p>However, achieving high performance is not easy. It requires a deep understanding of the language, the runtime, and the hardware. It also requires a lot of time and effort. In this blog post, we will discuss some of the techniques that can be used to optimize the performance of a programming language and how
we applied them to Pivot Lang.</p>
<h2 id="main-factors-affecting-performance"><a class="header" href="#main-factors-affecting-performance">Main Factors Affecting Performance</a></h2>
<h3 id="1-llvm-optimization"><a class="header" href="#1-llvm-optimization">1. LLVM Optimization</a></h3>
<p>LLVM is a powerful compiler infrastructure that can be used to generate highly optimized machine code. However, it can not do much if the ir code generated by the frontend is not following the best practices.
It is not enough to just generate correct code, you need to add various metadata to help LLVM optimize the code. You can find more information about this in the <a href="https://llvm.org/docs/Frontend/PerformanceTips.html">LLVM documentation</a>.</p>
<h3 id="2-garbage-collection"><a class="header" href="#2-garbage-collection">2. Garbage Collection</a></h3>
<p>If you are using a garbage collector, it is important to make sure that it integrates well with the rest of the system. Even the best garbage collector can cause performance issues if it is not used correctly.</p>
<p>Garbage collectors have two basic types: conservative and precise. There's not much we can do
while using third party fully conservative garbage collectors (like bdwgc), but with custom precise garbage collectors, we can
make a large difference by changing the mechanism of stack scanning, adjusting collect frequency etc.</p>
<h4 id="stack-scanning"><a class="header" href="#stack-scanning">Stack Scanning</a></h4>
<p>There are many different ways to scan the stack, if you are not using llvm's gc api, you can scan the stack
conservatively, very much like bdwgc does, it's fast enough in most cases. Otherwise, you can choose between
llvm's <code>gc.root</code> and <code>gc.statepoint</code> to perform precise stack scanning.
Even with the same llvm scanning method, you can still make a difference by changing the way you
crawl the stack, for example, you can use libunwind to walk the whole stack, or you can use llvm's
inline assembly to get the stack pointer and walk the stack manually by the help of <code>stackmap</code>.
Those mechanisms are discussed in detail in the <a href="https://yuchenx.pages.dev/blog/llvm/llvm-and-gc/">LLVM and GC</a> post.</p>
<h4 id="collect-frequency"><a class="header" href="#collect-frequency">Collect Frequency</a></h4>
<p>The frequency of garbage collection can have a big impact on performance.
Different GC algorithms may have different optimal collect frequencies, and it
may not make sense at all for some concurrent GCs.
Generally speaking, GC should take less than 10% of the total time,
otherwise, you should consider optimizing it.</p>
<h4 id="allocation"><a class="header" href="#allocation">Allocation</a></h4>
<p>The way you allocate memory can also have a big impact on performance.
Memory allocation is a well-known hot path in many programs,
especially in programs that allocate all objects on the heap.
You should make sure your allocator is fast and efficient.
A good allocator should allocate memory at least as fast as libc's <code>malloc</code>
in single-threaded environments.</p>
<p>Although a good allocator can improve performance, it won't help much if you are
allocating memory too frequently. You should try to minimize the number of heap
allocations in your program. This can be done either by dead code elimination or
by replacing some heap allocations with stack allocations.</p>
<p>As mentioned in <a href="https://yuchenx.pages.dev/blog/llvm/llvm-and-gc/">the blog</a>,
you can add metadata <code>allockind(&quot;alloc&quot;)</code> to your custom allocate function
to allow llvm to optimize away some allocations.</p>
<p>On the other hand, you can also use <code>alloca</code> to replace some heap allocations,
the well-known language golang uses a simmilar mechanism to reduce the number of heap allocations.
However there's no built-in pass in llvm to do this, you have to write your own pass.
Fortunately, llvm does provide an analysis pass named <code>CaptureTracking</code> which can help you
to determine whether a heap pointer can be safely replaced with <code>alloca</code>.</p>
<p>Please note that replacing heap allocations with stack allocations can be dangerous,
especially if you are using a precise relocating garbage collector. Things can get
complicated in this case, and you may need to add some extra metadata to help the
pass to determine whether a not captured pointer can be safely replaced with <code>alloca</code>.</p>
<p>Take Pivot Lang as an example, we originally used a precise relocating garbage collector,
and our GC used a visitor function on the object header to precisely mark complex objects like
structs, arrays, etc. Imagine if we replaced a heap allocation of a complex object with <code>alloca</code>,
then the visitor function is also on the stack, and we in fact cannot use it to mark the object,
as we cannot distinguish the visitor function from other stack data. This is not a problem
if we conservatively scan the stack if all the heap pointers in the stack are <strong>ordinary</strong> --
which means our GC can know the exact way to scan their content based only on the pointer itself.
In Pivot Lang, array types are not ordinary, so we added extra metadata to help the pass to
disambiguate the array type from others. So at last, our GC becomes a hybrid one, which
scans the stack conservatively and scans the heap precisely. We are undertaking this approach to achieve a substantial reduction in the number of heap allocations, even if it means slightly slowing down the speed of stack scanning.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../blogs/gc_for_beginner.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../blogs/gc_for_beginner.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
